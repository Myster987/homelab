- name: Disable swap now
  ansible.builtin.command: swapoff -a
  when: ansible_swaptotal_mb | int > 0

- name: Remove swap entries from fstab
  ansible.builtin.replace:
      path: /etc/fstab
      regexp: "^.* swap .*$"
      replace: ""

- name: Disable Firewall
  ansible.builtin.systemd:
      name: ufw
      enabled: no
      state: stopped

- name: Add Kubernetes kernel sysctl parameters
  ansible.builtin.copy:
      dest: /etc/sysctl.d/kubernetes.conf
      content: |
          net.ipv4.ip_forward=1

- name: Reload sysctl
  ansible.builtin.command: sysctl --system

- name: Install required base packages
  ansible.builtin.apt:
      name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gpg
      state: present
      update_cache: yes

- name: Add containerd repo
  ansible.builtin.apt_repository:
      repo: "ppa:containerd/containerd"
      state: present

- name: Install containerd
  ansible.builtin.apt:
      name: containerd
      state: latest
      update_cache: yes

- name: Ensure containerd config directory exists
  file:
      path: /etc/containerd
      state: directory

- name: Generate default containerd config if not exists
  command: containerd config default
  register: cont_config
  changed_when: cont_config.stdout != ""
  args:
      creates: /etc/containerd/config.toml

- name: Restart containerd
  ansible.builtin.systemd:
      name: containerd
      state: restarted
      enabled: yes

- name: Download kubernetes repo key
  tags:
      - machine-prep
  shell: |
      curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

- name: Install Kubernetes components
  ansible.builtin.apt:
      name:
          - kubelet
          - kubeadm
          - kubectl
      state: present
      update_cache: yes

- name: Hold Kubernetes packages at installed version
  ansible.builtin.apt:
      name:
          - kubelet
          - kubeadm
          - kubectl
      state: hold
